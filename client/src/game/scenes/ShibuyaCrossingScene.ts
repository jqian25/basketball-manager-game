/**
 * Ê∂©Ë∞∑ÂçÅÂ≠óË∑ØÂè£ÂÆåÊï¥Âú∫ÊôØ
 * ÂåÖÂê´ÔºöWASDÊéßÂà∂„ÄÅNPCÂØπËØù„ÄÅÂª∫Á≠ë‰∫§‰∫í„ÄÅÁ¢∞ÊíûÊ£ÄÊµã„ÄÅFateÈ£éÊ†ºÊîæÂ§ßÊïàÊûú
 */

import Phaser from 'phaser';

interface Building {
  sprite: Phaser.GameObjects.Image;
  name: string;
  type: 'shop' | 'restaurant' | 'arcade' | 'basketball_court' | 'station';
  interactionZone: Phaser.Geom.Rectangle;
  description: string;
}

interface NPC {
  sprite: Phaser.GameObjects.Sprite;
  name: string;
  role: string;
  personality: string;
  dialogues: string[];
  interactionZone: Phaser.Geom.Circle;
}

export class ShibuyaCrossingScene extends Phaser.Scene {
  // Áé©ÂÆ∂
  private player!: Phaser.GameObjects.Sprite;
  private playerSpeed: number = 200;
  
  // ÊéßÂà∂
  private keys!: {
    W: Phaser.Input.Keyboard.Key;
    A: Phaser.Input.Keyboard.Key;
    S: Phaser.Input.Keyboard.Key;
    D: Phaser.Input.Keyboard.Key;
    E: Phaser.Input.Keyboard.Key;
    ESC: Phaser.Input.Keyboard.Key;
  };
  
  // Âú∞ÂõæÂÖÉÁ¥†
  private background!: Phaser.GameObjects.Image;
  private buildings: Building[] = [];
  private npcs: NPC[] = [];
  
  // ‰∫§‰∫íÁ≥ªÁªü
  private nearbyBuilding: Building | null = null;
  private nearbyNPC: NPC | null = null;
  private isDialogueOpen: boolean = false;
  
  // UIÂÖÉÁ¥†
  private interactionPrompt!: Phaser.GameObjects.Container;
  private dialogueBox!: Phaser.GameObjects.Container;
  private buildingZoomOverlay!: Phaser.GameObjects.Container;
  
  // Â∞èÂú∞Âõæ
  private minimap!: Phaser.GameObjects.Container;

  constructor() {
    super({ key: 'ShibuyaCrossingScene' });
  }

  preload() {
    // Âä†ËΩΩËÉåÊôØ
    this.load.image('shibuya_bg', '/maps/tokyo/commercial/shibuya_crossing.png');
    
    // Âä†ËΩΩËßíËâ≤Á≤æÁÅµ
    this.load.image('player', '/sprites/player_main.png');
    this.load.image('npc_male', '/sprites/npc_male.png');
    this.load.image('npc_female', '/sprites/npc_female.png');
    this.load.image('shop_owner', '/sprites/shop_owner.png');
    this.load.image('coach', '/sprites/coach.png');
  }

  create() {
    const { width, height } = this.cameras.main;

    // 1. ÂàõÂª∫ËÉåÊôØÔºàÊîæÂ§ß‰ª•‰æøÊé¢Á¥¢Ôºâ
    this.background = this.add.image(0, 0, 'shibuya_bg');
    this.background.setOrigin(0, 0);
    this.background.setDisplaySize(width * 2, height * 2);

    // 2. ÂàõÂª∫Áé©ÂÆ∂
    this.player = this.add.sprite(width / 2, height / 2, 'player');
    this.player.setScale(3);
    this.player.setDepth(100);

    // 3. ËÆæÁΩÆÁõ∏Êú∫Ë∑üÈöèÁé©ÂÆ∂
    this.cameras.main.startFollow(this.player, true, 0.1, 0.1);
    this.cameras.main.setBounds(0, 0, width * 2, height * 2);

    // 4. ÂàõÂª∫Âª∫Á≠ëÁâ©
    this.createBuildings();

    // 5. ÂàõÂª∫NPC
    this.createNPCs();

    // 6. ËÆæÁΩÆWASDÈîÆÊéßÂà∂
    this.setupControls();

    // 7. ÂàõÂª∫UI
    this.createUI();

    // 8. ÂàõÂª∫Â∞èÂú∞Âõæ
    this.createMinimap();

    // 9. Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
    this.createDebugInfo();
  }

  private createBuildings() {
    const { width, height } = this.cameras.main;

    // Âª∫Á≠ëÁâ©ÈÖçÁΩÆÔºàÂü∫‰∫éÊ∂©Ë∞∑ÂçÅÂ≠óË∑ØÂè£ÁöÑÂÆûÈôÖÂ∏ÉÂ±ÄÔºâ
    const buildingConfigs = [
      {
        x: width * 0.3,
        y: height * 0.4,
        name: '109ÁôæË¥ß',
        type: 'shop' as const,
        description: 'Ê∂©Ë∞∑ÊúÄËëóÂêçÁöÑÊó∂Â∞öÁôæË¥ßÂïÜÂ∫ó',
        color: 0xFFD700
      },
      {
        x: width * 1.5,
        y: height * 0.5,
        name: 'TSUTAYA‰π¶Â∫ó',
        type: 'shop' as const,
        description: 'Ê∂©Ë∞∑Âú∞Ê†áÊÄßÁöÑ‰π¶Â∫óÂíåÈü≥‰πêÂ∫ó',
        color: 0x4169E1
      },
      {
        x: width * 0.8,
        y: height * 1.2,
        name: 'Ê∂©Ë∞∑ÁØÆÁêÉÈ¶Ü',
        type: 'basketball_court' as const,
        description: 'Ë°óÂ§¥ÁØÆÁêÉÂú£Âú∞ÔºåÂèØ‰ª•ËøõË°å3v3ÊØîËµõ',
        color: 0xFF6B35
      },
      {
        x: width * 1.3,
        y: height * 1.5,
        name: 'ÊãâÈù¢Â∫ó',
        type: 'restaurant' as const,
        description: 'ÊÅ¢Â§ç‰ΩìÂäõÁöÑÂ•ΩÂú∞Êñπ',
        color: 0xFF4757
      },
      {
        x: width * 0.5,
        y: height * 1.7,
        name: 'Ê∏∏Êàè‰∏≠ÂøÉ',
        type: 'arcade' as const,
        description: 'ÂèØ‰ª•Áé©Â∞èÊ∏∏ÊàèËµöÂèñÈáëÂ∏Å',
        color: 0x9B59B6
      },
      {
        x: width * 1.7,
        y: height * 1.3,
        name: 'Ê∂©Ë∞∑Á´ô',
        type: 'station' as const,
        description: 'ÂâçÂæÄÂÖ∂‰ªñ‰∏ú‰∫¨Âú∞Âå∫',
        color: 0x2ECC71
      }
    ];

    buildingConfigs.forEach(config => {
      // ÂàõÂª∫Âª∫Á≠ëÁâ©ÂõæÊ†áÔºàÁÆÄÂåñÁöÑÊñπÂùóÔºâ
      const graphics = this.add.graphics();
      graphics.fillStyle(config.color, 0.8);
      graphics.fillRoundedRect(0, 0, 80, 80, 10);
      graphics.lineStyle(3, 0xFFFFFF, 1);
      graphics.strokeRoundedRect(0, 0, 80, 80, 10);
      graphics.generateTexture(`building_${config.name}`, 80, 80);
      graphics.destroy();

      const sprite = this.add.image(config.x, config.y, `building_${config.name}`);
      sprite.setScale(1.5);
      sprite.setDepth(50);

      // Ê∑ªÂä†Âª∫Á≠ëÁâ©ÂêçÁß∞
      const nameText = this.add.text(config.x, config.y - 80, config.name, {
        fontSize: '20px',
        color: '#ffffff',
        backgroundColor: '#000000',
        padding: { x: 8, y: 4 }
      });
      nameText.setOrigin(0.5);
      nameText.setDepth(51);

      // Ê∑ªÂä†ÁâπÊÆäÂõæÊ†á
      let icon = '';
      if (config.type === 'basketball_court') icon = 'üèÄ';
      else if (config.type === 'restaurant') icon = 'üçú';
      else if (config.type === 'shop') icon = 'üõçÔ∏è';
      else if (config.type === 'arcade') icon = 'üéÆ';
      else if (config.type === 'station') icon = 'üöá';

      const iconText = this.add.text(config.x, config.y, icon, {
        fontSize: '40px'
      });
      iconText.setOrigin(0.5);
      iconText.setDepth(52);

      const building: Building = {
        sprite,
        name: config.name,
        type: config.type,
        interactionZone: new Phaser.Geom.Rectangle(
          config.x - 100,
          config.y - 100,
          200,
          200
        ),
        description: config.description
      };

      this.buildings.push(building);
    });
  }

  private createNPCs() {
    const { width, height } = this.cameras.main;

    const npcConfigs = [
      {
        x: width * 0.6,
        y: height * 0.7,
        sprite: 'coach',
        name: 'ÂÆâË•øÊïôÁªÉ',
        role: 'ÁØÆÁêÉÊïôÁªÉ',
        personality: '‰∏•Âéâ‰ΩÜÂÖ≥ÂøÉÂ≠¶ÁîüÔºåÁªèÈ™å‰∏∞ÂØå',
        dialogues: [
          'Âπ¥ËΩª‰∫∫ÔºåÊÉ≥Â≠¶ÁØÆÁêÉÂêóÔºü',
          'ÊîæÂºÉÊØîËµõÁöÑËØùÔºåÊØîËµõÂ∞±ÁªìÊùü‰∫Ü„ÄÇ',
          'Ê∂©Ë∞∑ÁØÆÁêÉÈ¶ÜÊ≠£Âú®ÊãõÂãüÊñ∞ÁêÉÂëòÔºÅ'
        ]
      },
      {
        x: width * 1.2,
        y: height * 0.9,
        sprite: 'npc_female',
        name: 'Êô¥Â≠ê',
        role: 'ÁØÆÁêÉÈòüÁªèÁêÜ',
        personality: 'ÁÉ≠ÊÉÖÂºÄÊúóÔºåÂñúÊ¨¢ÁØÆÁêÉ',
        dialogues: [
          '‰Ω†Â•ΩÔºÅ‰Ω†‰πüÂñúÊ¨¢ÁØÆÁêÉÂêóÔºü',
          'Ê∂©Ë∞∑ÂçÅÂ≠óË∑ØÂè£ÊÄªÊòØËøô‰πàÁÉ≠ÈóπÂë¢ÔºÅ',
          'Ë¶Å‰∏çË¶Å‰∏ÄËµ∑ÂéªÁúãÊØîËµõÔºü'
        ]
      },
      {
        x: width * 0.9,
        y: height * 1.4,
        sprite: 'npc_male',
        name: 'ÊµÅÂ∑ùÊû´',
        role: 'ÁØÆÁêÉÈ´òÊâã',
        personality: 'ÂÜ∑ÈÖ∑Ôºå‰∏ìÊ≥®ÁØÆÁêÉ',
        dialogues: [
          '...',
          'ÊÉ≥ÊåëÊàòÊàëÂêóÔºü',
          'ÁØÆÁêÉÈ¶ÜËßÅ„ÄÇ'
        ]
      },
      {
        x: width * 1.6,
        y: height * 1.1,
        sprite: 'shop_owner',
        name: 'ÂïÜÂ∫óËÄÅÊùø',
        role: '‰ΩìËÇ≤Áî®ÂìÅÂ∫óËÄÅÊùø',
        personality: 'ÂèãÂ•ΩÔºåÂÅ•Ë∞à',
        dialogues: [
          'Ê¨¢ËøéÂÖâ‰∏¥ÔºÅÈúÄË¶ÅÁØÆÁêÉË£ÖÂ§áÂêóÔºü',
          'ÊàëËøôÈáåÊúâÊúÄÊñ∞Ê¨æÁöÑÁêÉÈûãÔºÅ',
          '‰π∞Êª°1000Êó•ÂÖÉÈÄÅÊä§ËÖïÂì¶ÔºÅ'
        ]
      }
    ];

    npcConfigs.forEach(config => {
      const sprite = this.add.sprite(config.x, config.y, config.sprite);
      sprite.setScale(3);
      sprite.setDepth(90);

      // NPCÂêçÁß∞Ê†áÁ≠æ
      const nameTag = this.add.text(config.x, config.y - 60, config.name, {
        fontSize: '16px',
        color: '#ffffff',
        backgroundColor: '#000000',
        padding: { x: 6, y: 3 }
      });
      nameTag.setOrigin(0.5);
      nameTag.setDepth(91);

      const npc: NPC = {
        sprite,
        name: config.name,
        role: config.role,
        personality: config.personality,
        dialogues: config.dialogues,
        interactionZone: new Phaser.Geom.Circle(config.x, config.y, 100)
      };

      this.npcs.push(npc);

      // NPCÁÆÄÂçïÂä®ÁîªÔºà‰∏ä‰∏ãÊµÆÂä®Ôºâ
      this.tweens.add({
        targets: sprite,
        y: config.y - 10,
        duration: 2000,
        yoyo: true,
        repeat: -1,
        ease: 'Sine.easeInOut'
      });
    });
  }

  private setupControls() {
    this.keys = this.input.keyboard!.addKeys({
      W: Phaser.Input.Keyboard.KeyCodes.W,
      A: Phaser.Input.Keyboard.KeyCodes.A,
      S: Phaser.Input.Keyboard.KeyCodes.S,
      D: Phaser.Input.Keyboard.KeyCodes.D,
      E: Phaser.Input.Keyboard.KeyCodes.E,
      ESC: Phaser.Input.Keyboard.KeyCodes.ESC
    }) as any;

    // EÈîÆ‰∫§‰∫í
    this.keys.E.on('down', () => {
      if (this.nearbyBuilding && !this.isDialogueOpen) {
        this.interactWithBuilding(this.nearbyBuilding);
      } else if (this.nearbyNPC && !this.isDialogueOpen) {
        this.interactWithNPC(this.nearbyNPC);
      }
    });

    // ESCÈîÆÂÖ≥Èó≠ÂØπËØù
    this.keys.ESC.on('down', () => {
      if (this.isDialogueOpen) {
        this.closeDialogue();
      }
      if (this.buildingZoomOverlay.visible) {
        this.closeBuildingZoom();
      }
    });
  }

  private createUI() {
    const { width, height } = this.cameras.main;

    // ‰∫§‰∫íÊèêÁ§∫
    this.interactionPrompt = this.add.container(width / 2, height - 100);
    this.interactionPrompt.setScrollFactor(0);
    this.interactionPrompt.setDepth(200);
    this.interactionPrompt.setVisible(false);

    const promptBg = this.add.graphics();
    promptBg.fillStyle(0x000000, 0.8);
    promptBg.fillRoundedRect(-150, -30, 300, 60, 10);
    
    const promptText = this.add.text(0, 0, 'Êåâ E ÈîÆ‰∫§‰∫í', {
      fontSize: '24px',
      color: '#ffffff'
    });
    promptText.setOrigin(0.5);

    this.interactionPrompt.add([promptBg, promptText]);

    // ÂØπËØùÊ°Ü
    this.createDialogueBox();

    // Âª∫Á≠ëÁâ©ÊîæÂ§ßË¶ÜÁõñÂ±Ç
    this.createBuildingZoomOverlay();

    // È°∂ÈÉ®‰ø°ÊÅØÊ†è
    this.createTopBar();
  }

  private createDialogueBox() {
    const { width, height } = this.cameras.main;

    this.dialogueBox = this.add.container(width / 2, height - 150);
    this.dialogueBox.setScrollFactor(0);
    this.dialogueBox.setDepth(300);
    this.dialogueBox.setVisible(false);

    const dialogueBg = this.add.graphics();
    dialogueBg.fillStyle(0x000000, 0.9);
    dialogueBg.fillRoundedRect(-400, -80, 800, 160, 15);
    dialogueBg.lineStyle(3, 0xFFD700, 1);
    dialogueBg.strokeRoundedRect(-400, -80, 800, 160, 15);

    const npcNameText = this.add.text(-380, -60, '', {
      fontSize: '20px',
      color: '#FFD700',
      fontStyle: 'bold'
    });

    const dialogueText = this.add.text(-380, -20, '', {
      fontSize: '18px',
      color: '#ffffff',
      wordWrap: { width: 750 }
    });

    const continueText = this.add.text(350, 50, 'ÊåâESCÂÖ≥Èó≠', {
      fontSize: '14px',
      color: '#aaaaaa'
    });
    continueText.setOrigin(1, 0);

    this.dialogueBox.add([dialogueBg, npcNameText, dialogueText, continueText]);
  }

  private createBuildingZoomOverlay() {
    const { width, height } = this.cameras.main;

    this.buildingZoomOverlay = this.add.container(width / 2, height / 2);
    this.buildingZoomOverlay.setScrollFactor(0);
    this.buildingZoomOverlay.setDepth(400);
    this.buildingZoomOverlay.setVisible(false);

    // ÂçäÈÄèÊòéÈªëËâ≤ËÉåÊôØ
    const overlay = this.add.graphics();
    overlay.fillStyle(0x000000, 0.85);
    overlay.fillRect(-width / 2, -height / 2, width, height);

    // Âª∫Á≠ëÁâ©ËØ¶ÊÉÖÂç°Áâá
    const cardBg = this.add.graphics();
    cardBg.fillStyle(0x1a1a1a, 1);
    cardBg.fillRoundedRect(-350, -250, 700, 500, 20);
    cardBg.lineStyle(4, 0xFF6B35, 1);
    cardBg.strokeRoundedRect(-350, -250, 700, 500, 20);

    const buildingNameText = this.add.text(0, -200, '', {
      fontSize: '36px',
      color: '#FF6B35',
      fontStyle: 'bold'
    });
    buildingNameText.setOrigin(0.5);

    const buildingDescText = this.add.text(0, -130, '', {
      fontSize: '20px',
      color: '#ffffff',
      wordWrap: { width: 600 },
      align: 'center'
    });
    buildingDescText.setOrigin(0.5);

    const closeHint = this.add.text(0, 220, 'ÊåâESCÂÖ≥Èó≠ | ÊåâEËøõÂÖ•', {
      fontSize: '18px',
      color: '#aaaaaa'
    });
    closeHint.setOrigin(0.5);

    this.buildingZoomOverlay.add([overlay, cardBg, buildingNameText, buildingDescText, closeHint]);
  }

  private createTopBar() {
    const { width } = this.cameras.main;

    const topBar = this.add.graphics();
    topBar.fillStyle(0x000000, 0.7);
    topBar.fillRect(0, 0, width, 60);
    topBar.setScrollFactor(0);
    topBar.setDepth(150);

    const locationText = this.add.text(20, 15, 'üìç Ê∂©Ë∞∑ÂçÅÂ≠óË∑ØÂè£ (Shibuya Crossing)', {
      fontSize: '24px',
      color: '#ffffff',
      fontStyle: 'bold'
    });
    locationText.setScrollFactor(0);
    locationText.setDepth(151);

    const controlsText = this.add.text(width - 20, 15, 'WASDÁßªÂä® | E‰∫§‰∫í | ESCÂÖ≥Èó≠', {
      fontSize: '16px',
      color: '#aaaaaa'
    });
    controlsText.setOrigin(1, 0);
    controlsText.setScrollFactor(0);
    controlsText.setDepth(151);
  }

  private createMinimap() {
    const { width, height } = this.cameras.main;

    this.minimap = this.add.container(width - 170, height - 170);
    this.minimap.setScrollFactor(0);
    this.minimap.setDepth(200);

    // Â∞èÂú∞ÂõæËÉåÊôØ
    const minimapBg = this.add.graphics();
    minimapBg.fillStyle(0x000000, 0.7);
    minimapBg.fillRoundedRect(0, 0, 150, 150, 10);
    minimapBg.lineStyle(2, 0xFFFFFF, 0.5);
    minimapBg.strokeRoundedRect(0, 0, 150, 150, 10);

    const minimapTitle = this.add.text(75, 10, 'Â∞èÂú∞Âõæ', {
      fontSize: '14px',
      color: '#ffffff'
    });
    minimapTitle.setOrigin(0.5);

    this.minimap.add([minimapBg, minimapTitle]);
  }

  private createDebugInfo() {
    const debugText = this.add.text(10, 70, '', {
      fontSize: '14px',
      color: '#00ff00',
      backgroundColor: '#000000',
      padding: { x: 5, y: 3 }
    });
    debugText.setScrollFactor(0);
    debugText.setDepth(500);

    this.events.on('update', () => {
      debugText.setText([
        `Áé©ÂÆ∂‰ΩçÁΩÆ: (${Math.floor(this.player.x)}, ${Math.floor(this.player.y)})`,
        `ÈôÑËøëÂª∫Á≠ë: ${this.nearbyBuilding?.name || 'Êó†'}`,
        `ÈôÑËøëNPC: ${this.nearbyNPC?.name || 'Êó†'}`,
        `ÂØπËØùÁä∂ÊÄÅ: ${this.isDialogueOpen ? 'ÊâìÂºÄ' : 'ÂÖ≥Èó≠'}`
      ]);
    });
  }

  update() {
    if (this.isDialogueOpen || this.buildingZoomOverlay.visible) {
      return; // ÂØπËØùÊàñÊü•ÁúãÂª∫Á≠ëÊó∂‰∏çËÉΩÁßªÂä®
    }

    // WASDÁßªÂä®
    let velocityX = 0;
    let velocityY = 0;

    if (this.keys.W.isDown) velocityY = -this.playerSpeed;
    if (this.keys.S.isDown) velocityY = this.playerSpeed;
    if (this.keys.A.isDown) velocityX = -this.playerSpeed;
    if (this.keys.D.isDown) velocityX = this.playerSpeed;

    // ÂØπËßíÁ∫øÁßªÂä®ÈÄüÂ∫¶ÂΩí‰∏ÄÂåñ
    if (velocityX !== 0 && velocityY !== 0) {
      velocityX *= 0.707;
      velocityY *= 0.707;
    }

    this.player.x += velocityX * (this.game.loop.delta / 1000);
    this.player.y += velocityY * (this.game.loop.delta / 1000);

    // ÈôêÂà∂Áé©ÂÆ∂Âú®Âú∞ÂõæËæπÁïåÂÜÖ
    const { width, height } = this.cameras.main;
    this.player.x = Phaser.Math.Clamp(this.player.x, 50, width * 2 - 50);
    this.player.y = Phaser.Math.Clamp(this.player.y, 50, height * 2 - 50);

    // Ê£ÄÊµãÈôÑËøëÁöÑÂª∫Á≠ëÁâ©
    this.checkNearbyBuildings();

    // Ê£ÄÊµãÈôÑËøëÁöÑNPC
    this.checkNearbyNPCs();

    // Êõ¥Êñ∞Â∞èÂú∞Âõæ
    this.updateMinimap();
  }

  private checkNearbyBuildings() {
    let foundBuilding = false;

    for (const building of this.buildings) {
      if (building.interactionZone.contains(this.player.x, this.player.y)) {
        this.nearbyBuilding = building;
        foundBuilding = true;
        
        // ÊòæÁ§∫‰∫§‰∫íÊèêÁ§∫
        if (!this.isDialogueOpen) {
          this.interactionPrompt.setVisible(true);
          const promptText = this.interactionPrompt.getAt(1) as Phaser.GameObjects.Text;
          promptText.setText(`Êåâ E Êü•Áúã ${building.name}`);
        }
        
        break;
      }
    }

    if (!foundBuilding) {
      this.nearbyBuilding = null;
      if (!this.nearbyNPC) {
        this.interactionPrompt.setVisible(false);
      }
    }
  }

  private checkNearbyNPCs() {
    let foundNPC = false;

    for (const npc of this.npcs) {
      if (npc.interactionZone.contains(this.player.x, this.player.y)) {
        this.nearbyNPC = npc;
        foundNPC = true;
        
        // ÊòæÁ§∫‰∫§‰∫íÊèêÁ§∫
        if (!this.isDialogueOpen && !this.nearbyBuilding) {
          this.interactionPrompt.setVisible(true);
          const promptText = this.interactionPrompt.getAt(1) as Phaser.GameObjects.Text;
          promptText.setText(`Êåâ E ‰∏é ${npc.name} ÂØπËØù`);
        }
        
        break;
      }
    }

    if (!foundNPC) {
      this.nearbyNPC = null;
      if (!this.nearbyBuilding) {
        this.interactionPrompt.setVisible(false);
      }
    }
  }

  private interactWithBuilding(building: Building) {
    console.log(`‰∏éÂª∫Á≠ëÁâ©‰∫§‰∫í: ${building.name}`);
    
    // ÊòæÁ§∫Âª∫Á≠ëÁâ©ÊîæÂ§ßÊïàÊûú
    this.buildingZoomOverlay.setVisible(true);
    
    const nameText = this.buildingZoomOverlay.getAt(2) as Phaser.GameObjects.Text;
    const descText = this.buildingZoomOverlay.getAt(3) as Phaser.GameObjects.Text;
    
    nameText.setText(building.name);
    descText.setText(building.description);

    // Â¶ÇÊûúÊòØÁØÆÁêÉÂú∫ÔºåÊ∑ªÂä†ÁâπÊÆäÊèêÁ§∫
    if (building.type === 'basketball_court') {
      descText.setText(
        building.description + '\n\n' +
        'üèÄ ÂèØ‰ª•ËøõË°åÊØîËµõËÆ≠ÁªÉ\n' +
        'üí™ ÊèêÂçáÁêÉÂëòËÉΩÂäõ\n' +
        'üèÜ ÂèÇÂä†Ë°óÂ§¥ËÅîËµõ'
      );
    }
  }

  private interactWithNPC(npc: NPC) {
    console.log(`‰∏éNPCÂØπËØù: ${npc.name}`);
    
    this.isDialogueOpen = true;
    this.dialogueBox.setVisible(true);
    this.interactionPrompt.setVisible(false);
    
    const nameText = this.dialogueBox.getAt(1) as Phaser.GameObjects.Text;
    const dialogueText = this.dialogueBox.getAt(2) as Phaser.GameObjects.Text;
    
    nameText.setText(`${npc.name} (${npc.role})`);
    
    // ÈöèÊú∫ÈÄâÊã©‰∏ÄÂè•ÂØπËØù
    const randomDialogue = Phaser.Math.RND.pick(npc.dialogues);
    dialogueText.setText(randomDialogue);

    // NPCËØ¥ËØùÂä®Áîª
    this.tweens.add({
      targets: npc.sprite,
      scaleX: 3.2,
      scaleY: 3.2,
      duration: 200,
      yoyo: true,
      ease: 'Sine.easeInOut'
    });
  }

  private closeDialogue() {
    this.isDialogueOpen = false;
    this.dialogueBox.setVisible(false);
  }

  private closeBuildingZoom() {
    this.buildingZoomOverlay.setVisible(false);
  }

  private updateMinimap() {
    // Ê∏ÖÈô§ÊóßÁöÑÂ∞èÂú∞ÂõæÂÜÖÂÆπ
    while (this.minimap.length > 2) {
      const child = this.minimap.getAt(2);
      if (child) {
        child.destroy();
      }
    }

    const minimapScale = 0.05; // Áº©ÊîæÊØî‰æã
    const minimapOffsetX = 75;
    const minimapOffsetY = 75;

    // ÁªòÂà∂Áé©ÂÆ∂‰ΩçÁΩÆÔºàÁ∫¢ÁÇπÔºâ
    const playerDot = this.add.circle(
      minimapOffsetX + this.player.x * minimapScale,
      minimapOffsetY + this.player.y * minimapScale,
      3,
      0xFF0000
    );
    this.minimap.add(playerDot);

    // ÁªòÂà∂Âª∫Á≠ëÁâ©ÔºàÈªÑÁÇπÔºâ
    this.buildings.forEach(building => {
      const buildingDot = this.add.circle(
        minimapOffsetX + building.sprite.x * minimapScale,
        minimapOffsetY + building.sprite.y * minimapScale,
        2,
        0xFFFF00
      );
      this.minimap.add(buildingDot);
    });

    // ÁªòÂà∂NPCÔºàÁªøÁÇπÔºâ
    this.npcs.forEach(npc => {
      const npcDot = this.add.circle(
        minimapOffsetX + npc.sprite.x * minimapScale,
        minimapOffsetY + npc.sprite.y * minimapScale,
        2,
        0x00FF00
      );
      this.minimap.add(npcDot);
    });
  }
}

